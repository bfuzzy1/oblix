<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>oblix-rl demo</title>
  <link rel="stylesheet" href="./src/ui/styles.css">
</head>
<body>
  <h1>oblix-rl Grid World</h1>
  <div id="grid"></div>
  <div id="metrics">
    <div>Episode: <span id="episode">1</span></div>
    <div>Steps: <span id="steps">0</span></div>
    <div>Cumulative Reward: <span id="reward">0</span></div>
    <div>Epsilon: <span id="epsilon">1</span></div>
  </div>
  <canvas id="liveChart" width="400" height="200"></canvas>
  <div>
    <label>Agent:
        <select id="agent-select">
          <option value="rl">Q-learning</option>
          <option value="sarsa">SARSA</option>
          <option value="expected">Expected SARSA</option>
          <option value="dyna">Dyna-Q</option>
        </select>
      </label>
    </div>
  <div>
    <label>Epsilon: <input type="range" id="epsilon-slider" min="0" max="1" step="0.01" value="1"><span id="epsilon-value">1</span></label>
  </div>
  <div>
    <label>Learning Rate: <input type="range" id="learning-rate-slider" min="0" max="1" step="0.01" value="0.1"><span id="learning-rate-value">0.10</span></label>
  </div>
  <div>
    <label>Interval (ms): <input type="range" id="interval-slider" min="10" max="1000" step="10" value="100"><span id="interval-value">100</span></label>
  </div>
  <div>
    <button id="start">Start</button>
    <button id="pause">Pause</button>
    <button id="reset">Reset</button>
    <button id="save">Save</button>
    <button id="load">Load</button>
  </div>
  <script type="module">
    import { GridWorldEnvironment } from './src/rl/environment.js';
    import { RLAgent } from './src/rl/agent.js';
    import { SarsaAgent } from './src/rl/sarsaAgent.js';
    import { ExpectedSarsaAgent } from './src/rl/expectedSarsaAgent.js';
    import { DynaQAgent } from './src/rl/dynaQAgent.js';
    import { RLTrainer } from './src/rl/training.js';
    import { saveAgent, loadAgent } from './src/rl/storage.js';
    import { LiveChart } from './src/ui/liveChart.js';

    const size = 5;
    const env = new GridWorldEnvironment(size);

    function createAgent(type) {
      const options = { epsilon: 1, epsilonDecay: 0.995, minEpsilon: 0.05 };
      if (type === 'sarsa') return new SarsaAgent(options);
      if (type === 'expected') return new ExpectedSarsaAgent(options);
      if (type === 'dyna') return new DynaQAgent(options);
      return new RLAgent(options);
    }

    let agent = createAgent('rl');
    const gridEl = document.getElementById('grid');
    gridEl.style.setProperty('--size', size);
   
    const agentSelect = document.getElementById('agent-select');
    const liveChart = new LiveChart(document.getElementById('liveChart'));
    const epsilonSlider = document.getElementById('epsilon-slider');
    const epsilonValue = document.getElementById('epsilon-value');
    const intervalSlider = document.getElementById('interval-slider');
    const intervalValue = document.getElementById('interval-value');
    const learningRateSlider = document.getElementById('learning-rate-slider');
    const learningRateValue = document.getElementById('learning-rate-value');

    function syncLearningRate() {
      learningRateSlider.value = agent.learningRate;
      learningRateValue.textContent = agent.learningRate.toFixed(2);
    }


    function render(state) {
      gridEl.innerHTML = '';
      for (let y = 0; y < size; y++) {
        for (let x = 0; x < size; x++) {
          const cell = document.createElement('div');
          cell.className = 'cell';
          if (env.isObstacle(x, y)) cell.classList.add('obstacle');
          if (x === state[0] && y === state[1]) cell.classList.add('agent');
          if (x === size - 1 && y === size - 1) cell.classList.add('goal');
          cell.addEventListener('click', () => {
            if (x === env.agentPos.x && y === env.agentPos.y) return;
            if (x === size - 1 && y === size - 1) return;
            env.toggleObstacle(x, y);
            render(env.getState());
          });
          gridEl.appendChild(cell);
        }
      }
    }

    const trainer = new RLTrainer(agent, env, {
      intervalMs: 100,
      liveChart,
      onStep: (state, reward, done, metrics) => {
        render(state);
        document.getElementById('episode').textContent = metrics.episode;
        document.getElementById('steps').textContent = metrics.steps;
        document.getElementById('reward').textContent = metrics.cumulativeReward.toFixed(2);
        document.getElementById('epsilon').textContent = metrics.epsilon.toFixed(2);

        epsilonSlider.value = metrics.epsilon;
        epsilonValue.textContent = metrics.epsilon.toFixed(2);
      }
    });

    epsilonSlider.value = agent.epsilon;
    epsilonValue.textContent = agent.epsilon.toFixed(2);
    intervalSlider.value = trainer.intervalMs;
    intervalValue.textContent = trainer.intervalMs;
    syncLearningRate();

    agentSelect.addEventListener('change', e => {
      agent = createAgent(e.target.value);
      trainer.agent = agent;
      trainer.reset();
      epsilonSlider.value = agent.epsilon;
      epsilonValue.textContent = agent.epsilon.toFixed(2);
      syncLearningRate();
    });

    epsilonSlider.addEventListener('input', e => {
      const val = parseFloat(e.target.value);
      agent.epsilon = val;
      trainer.metrics.epsilon = val;
      epsilonValue.textContent = val.toFixed(2);
      document.getElementById('epsilon').textContent = val.toFixed(2);
    });

    intervalSlider.addEventListener('input', e => {
      const val = parseInt(e.target.value, 10);
      trainer.setIntervalMs(val);
      intervalValue.textContent = val;
    });

    learningRateSlider.addEventListener('input', e => {
      const val = parseFloat(e.target.value);
      agent.learningRate = val;
      learningRateValue.textContent = val.toFixed(2);
    });

    document.getElementById('start').onclick = () => trainer.start();
    document.getElementById('pause').onclick = () => trainer.pause();
    document.getElementById('reset').onclick = () => {
      trainer.reset();
      epsilonSlider.value = agent.epsilon;
      epsilonValue.textContent = agent.epsilon.toFixed(2);
      syncLearningRate();
    };
    document.getElementById('save').onclick = () => saveAgent(agent);
    document.getElementById('load').onclick = () => {
      agent = loadAgent(trainer);
      epsilonSlider.value = agent.epsilon;
      epsilonValue.textContent = agent.epsilon.toFixed(2);
      syncLearningRate();
      render(trainer.state);
    };

    render(env.reset());
  </script>
</body>
</html>
